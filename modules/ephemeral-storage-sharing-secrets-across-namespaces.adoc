// Module included in the following assemblies:
//
// * work_with_shared_resources/using-shared-resource-csi-driver.adoc

:_mod-docs-content-type: PROCEDURE

[id="ephemeral-storage-sharing-secrets-across-namespaces_{context}"]
= Sharing secrets across namespaces

To share a secret across namespaces in a cluster, you create a `SharedSecret` custom resource (CR) instance for the `Secret` object.

.Prerequisites

* You have created a `Secret` object that you want to share in other namespaces.
* You must have permissions to perform the following actions:
** You subscribed to the cluster and have entitlement keys synced through the Insights Operator.
** You created the instances of the `sharedsecrets.sharedresource.openshift.io` custom resource definition (CRD) at a cluster-scoped level.
** You created the `ClusterRole` object for the `SharedConfigMap CR`.
** You created the `Role` and `RoleBinding` objects for the Shared Resource CSI Driver.
** You managed roles and role bindings across the namespaces in the cluster to control users.
** You managed roles and role bindings to control whether the service account specified by a pod can mount a Container Storage Interface (CSI) volume that references the `Secret` or `Configmap` CR you want to use.
** You have access to the namespaces that contain the secrets you want to share.

.Procedure

. Create a `SharedSecret` instance to share the referenced `Secret` across namespaces in the cluster by using the following example configuration:
+
[source,yaml]
----
apiVersion: sharedresource.openshift.io/v1alpha1
kind: SharedSecret
metadata:
  name: shared-test-secret <1>
spec:
  secretRef:
    name: test-secret
    namespace: <name_of_the_source_namespace>
----
<1> Defines the name of the `SharedSecret` CR.

. Create a `ClusterRole` object that grants RBAC permission to use the referenced shared resource by using the following example configuration: 
+
[source,yaml]
----
. apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: use-shared-test-secret <1>
rules:
  - apiGroups:
      - sharedresource.openshift.io
    resources:
      - sharedsecrets
    resourceNames:
      - shared-test-secret
    verbs:
      - use
----
<1> Defines the name of the `ClusterRole` CR.

. Create the `Role` and `RoleBinding` objects that grant the Shared Resources CSI driver the permission to access the `SharedSecret` object:
+
.Example `Role` object
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: share-etc-pki-entitlement <1>
  namespace: openshift-config-managed
rules:
  - apiGroups:
      - ""
    resources:
      - secrets
    resourceNames:
      - etc-pki-entitlement
    verbs:
      - get
      - list
      - watch
----
<1> Defines the name of the `Role` CR.

+
.Example `RoleBinding` object
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: share-etc-pki-entitlement <1>
  namespace: openshift-config-managed
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: share-etc-pki-entitlement <2>
subjects:
  - kind: ServiceAccount
    name: csi-driver-shared-resource <3>
    namespace: openshift-builds
----
<1> Defines the name of the `RoleBinding` CR.
<2> Defines the name of the `Role` CR.
<3> Defines the name of the `ServiceAccount` CR.