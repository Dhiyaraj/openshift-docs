// This module is included in the following assemblies:
// * pac/managing-pipeline-runs-pac.adoc

:_mod-docs-content-type: REFERENCE
[id="creating-pipeline-run-using-pipelines-as-code_{context}"]
= Creating a pipeline run using {pac}

[role="_abstract"]
To run pipelines using {pac}, you can create pipeline run definitions or templates as YAML files in the `.tekton/` directory of the repository. You can reference YAML files in other repositories using remote URLs, but pipeline runs are only triggered by events in the repository containing the `.tekton/` directory.

The {pac} resolver bundles the pipeline runs with all tasks as a single pipeline run without external dependencies.

[NOTE]
====
* For pipelines, use at least one pipeline run with a spec, or a separated `Pipeline` object.
* For tasks, embed task spec inside a pipeline, or define it separately as a Task object.
====

[discrete]
.Parameterizing commits and URLs

You can specify the parameters of your commit and URL by using dynamic, expandable variables with the {{<var>}} format. Currently, you can use the following variables:

* `{{repo_owner}}`: The repository owner.
* `{{repo_name}}`: The repository name.
* `{{repo_url}}`: The repository full URL.
* `{{revision}}`: Full SHA revision of a commit.
* `{{sender}}`: The username or account id of the sender of the commit.
* `{{source_branch}}`: The branch name where the event originated.
* `{{target_branch}}`: The branch name that the event targets. For push events, it's the same as the `source_branch`.
* `{{pull_request_number}}`: The pull or merge request number, defined only for a `pull_request` event type.
* `{{git_auth_secret}}`: The secret name that is generated automatically with Git provider's token for checking out private repos.

[discrete]
.Matching an event to a pipeline run

You can match different Git provider events with each pipeline run by using special annotations on the pipeline run. If there are multiple pipeline runs matching an event, {pac} runs them in parallel and posts the results to the Git provider as soon a pipeline run finishes.

[discrete]
.Matching a pull event to a pipeline run

You can use the following example to match the `pipeline-pr-main` pipeline run with a `pull_request` event that targets the `main` branch:

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-pr-main
annotations:
  pipelinesascode.tekton.dev/on-target-branch: "[main]" <1>
  pipelinesascode.tekton.dev/on-event: "[pull_request]"
# ...
----
<1> You can specify multiple branches by adding comma-separated entries. For example, `"[main, release-nightly]"`. In addition, you can specify the following:
* Full references to branches such as `"refs/heads/main"`
* Globs with pattern matching such as `"refs/heads/\*"`
* Tags such as `"refs/tags/1.\*"`

[discrete]
.Matching a push event to a pipeline run

You can use the following example to match the `pipeline-push-on-main` pipeline run with a `push` event targeting the `refs/heads/main` branch:

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-push-on-main
annotations:
  pipelinesascode.tekton.dev/on-target-branch: "[refs/heads/main]" <1>
  pipelinesascode.tekton.dev/on-event: "[push]"
# ...
----
<1> You can specify multiple branches by adding comma-separated entries. For example, `"[main, release-nightly]"`. In addition, you can specify the following:
* Full references to branches such as `"refs/heads/main"`
* Globs with pattern matching such as `"refs/heads/\*"`
* Tags such as `"refs/tags/1.\*"`

[discrete]
.Matching a pull request label to a pipeline run

// Note for reviewers: passive voice unfortunately seems to be necessary in the following paragraph. A label can be added to a pull request by an automated system as well as a user, so there is no subject to mention. The same applies to updating the PR with a new commit

You can match a pipeline run to one or several pull request labels. {pac} starts the pipeline run when any of these labels is added to a pull request. When the pull request is updated with a new commit, if the pull request still has the label, {pac} starts the pipeline run again.

You can use the following example to match the `pipeline-bug-or-defect` pipeline run when either the `bug` label or the `defect` label is added to a pull request, and also when a pull request with this label is updated with a new commit:

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-bug-or-defect
annotations:
  pipelinesascode.tekton.dev/on-label: "[bug, defect]"
# ...
----

[NOTE]
====
The current version of {pac} supports matching events to pull request labels only for the GitHub, Gitea, and GitLab repository hosting service providers.
====

:FeatureName: Matching pull request labels a pipeline run
include::snippets/technology-preview.adoc[]

[discrete]
.Matching a comment event to a pipeline run

You can use the following example to match the `pipeline-comment` pipeline run with a comment on a pull request, when the text of the comment matches the `^/merge-pr` regular expression:

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-comment
annotations:
  pipelinesascode.tekton.dev/on-comment: "^/merge-pr"
# ...
----

The pipeline run starts only if the comment author meets one of the following requirements:

* The author is the owner of the repository.
* The author is a collaborator on the repository.
* The author is a public member on the organization of the repository.
* The comment author is listed in the `approvers` or `reviewers` section of the `OWNERS` file in the root of the repository, as defined in the https://www.kubernetes.dev/docs/guide/owners/[Kubernetes documentation]. {pac} supports the specification for the `OWNERS` and `OWNERS_ALIASES` files. If the `OWNERS` file includes a https://github.com/kubernetes/community/blob/master/contributors/guide/owners.md#filters[filters] section, {pac} matches approvers and reviewers only against the `.*` filter.

:FeatureName: Matching a comment event to a pipeline run
include::snippets/technology-preview.adoc[]

[discrete]
.Advanced event matching

{pac} supports using Common Expression Language (CEL) based filtering for advanced event matching. If you have the `pipelinesascode.tekton.dev/on-cel-expression` annotation in your pipeline run, {pac} uses the CEL expression and skips the `on-target-branch` annotation. Compared to the simple `on-target-branch` annotation matching, the CEL expressions allow complex filtering and negation.

To use CEL-based filtering with {pac}, consider the following examples of annotations:

* To match a `pull_request` event targeting the `main` branch and coming from the `wip` branch:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request" && target_branch == "main" && source_branch == "wip"
...
----

* To run a pipeline only if a path has changed, you can use the `.pathChanged` suffix function with a glob pattern:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr-pathchanged
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request" && "docs/\*.md".pathChanged() # <1>
# ...
----
<1> Matches all markdown files in the `docs` directory.

* To match all pull requests starting with the title `[DOWNSTREAM]`:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr-downstream
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request && event_title.startsWith("[DOWNSTREAM]")
# ...
----

* To run a pipeline on a `pull_request` event, but skip the `experimental` branch:
+
[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: pipeline-advanced-pr-not-experimental
annotations:
  pipelinesascode.tekton.dev/on-cel-expression: |
    event == "pull_request" && target_branch != experimental"
# ...
----

For advanced CEL-based filtering while using {pac}, you can use the following fields and suffix functions:

* `event`: A `push` or `pull_request` event.
* `target_branch`: The target branch.
* `source_branch`: The branch of origin of a `pull_request` event. For `push` events, it is same as the `target_branch`.
* `event_title`: Matches the title of the event, such as the commit title for a `push` event, and the title of a pull or merge request for a `pull_request` event. Currently, only GitHub, Gitlab, and Bitbucket Cloud are the supported providers.
* `.pathChanged`: A suffix function to a string. The string can be a glob of a path to check if the path has changed. Currently, only GitHub and Gitlab are supported as providers.

In addition, you can access the full payload as passed by the Git repository provider. Use the `headers` field to access the headers of the payload, for example, `headers['x-github-event']`. Use the `body` field to access the body of the payload, for example, `body.pull_request.state`.

:FeatureName: Using the header and body of the payload for CEL-based filtering with {pac}
include::snippets/technology-preview.adoc[]

In the following example, the pipeline run starts only if all of the following conditions are true:

* The pull request is targeting the `main` branch.
* The author of the pull request is `superuser`.
* The action is `synchronize`; this action triggers when an update occurs on a pull request.

[source,yaml]
----
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  annotations:
    pipelinesascode.tekton.dev/on-cel-expression: |
      body.pull_request.base.ref == "main" &&
        body.pull_request.user.login == "superuser" &&
        body.action == "synchronize"
# ...
----

[NOTE]
====
If you use the `header` or `body` field for event matching, you might be unable to trigger the pipeline run using Git commands such as `retest`. If you use a Git command, the payload body is the comment that contains this command and not the original payload.

If you want to trigger the pipeline run again when using the `body` field for event matching, you can close and reopen the pull request or merge request, or alternatively add a new SHA commit, for example using the following command:

[source,terminal]
----
git commit --amend --no-edit && git push --force-with-lease
----
====

[discrete]
.Using the temporary GitHub App token for Github API operations

You can use the temporary installation token generated by {pac} from GitHub App to access the GitHub API. The token value is stored in the temporary `{{git_auth_secret}}` dynamic variable generated for private repositories in the `git-provider-token` key.

For example, to add a comment to a pull request, you can use the `github-add-comment` task from {tekton-hub} using a {pac} annotation:

[source,yaml]
----
...
  pipelinesascode.tekton.dev/task: "github-add-comment"
...
----

You can then add a task to the `tasks` section or `finally` tasks in the pipeline run definition:

[source,yaml]
----
[...]
tasks:
  - name:
      taskRef:
        name: github-add-comment
      params:
        - name: REQUEST_URL
          value: "{{ repo_url }}/pull/{{ pull_request_number }}" <1>
        - name: COMMENT_OR_FILE
          value: "Pipelines as Code IS GREAT!"
        - name: GITHUB_TOKEN_SECRET_NAME
          value: "{{ git_auth_secret }}"
        - name: GITHUB_TOKEN_SECRET_KEY
          value: "git-provider-token"
...
----
<1> By using the dynamic variables, you can reuse this snippet template for any pull request from any repository.

[NOTE]
====
On GitHub Apps, the generated installation token is available for 8 hours and scoped to the repository from where the events originate unless configured differently on the cluster.
====
