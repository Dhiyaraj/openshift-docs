// This module is used in the following assemblies:

// * install/ossm-multi-cluster-topologies.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-creating-certificates-for-a-multi-cluster-topology_{context}"]
= Creating certificates for a multi-cluster topology 

Create the root and intermediate certificate authority (CA) certificates for two clusters.

.Prerequisites

* You have OpenSSL installed locally.

.Procedure

. Create the root CA certificate:

.. Create a key for the root certificate by running the following command:
+
[source,terminal]
----
$ openssl genrsa -out root-key.pem 4096
----

.. Create an OpenSSL configuration certificate file named `root-ca.conf` for the root CA certificates:
+
.Example root certificate configuration file
[source,terminal]
----
encrypt_key = no
prompt = no
utf8 = yes
default_md = sha256
default_bits = 4096
req_extensions = req_ext
x509_extensions = req_ext
distinguished_name = req_dn
[ req_ext ]
subjectKeyIdentifier = hash
basicConstraints = critical, CA:true
keyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, keyCertSign
[ req_dn ]
O = Istio
CN = Root CA
----

.. Create the certificate signing request by running the following command:
+
[source,terminal]
----
$ openssl req -sha256 -new -key root-key.pem \
  -config root-ca.conf \
  -out root-cert.csr
----

.. Create a shared root certificate by running the following command:
+
[source,terminal]
----
$ openssl x509 -req -sha256 -days 3650 \
  -signkey root-key.pem \
  -extensions req_ext -extfile root-ca.conf \
  -in root-cert.csr \
  -out root-cert.pem
----

. Create the intermediate CA certificate for the East cluster:

.. Create a directory named `east` by running the following command:
+
[source,terminal]
----
$ mkdir east
----

.. Create a key for the intermediate certificate for the East cluster by running the following command:
+
[source,terminal]
----
$ openssl genrsa -out east/ca-key.pem 4096
----

.. Create an OpenSSL configuration file named `intermediate.conf` in the `east/` directory for the intermediate certificate of the East cluster. Copy the following example file and save it locally:
+
.Example configuration file
[source,subs="attributes,verbatim"]
----
[ req ]
encrypt_key = no
prompt = no
utf8 = yes
default_md = sha256
default_bits = 4096
req_extensions = req_ext
x509_extensions = req_ext
distinguished_name = req_dn
[ req_ext ]
subjectKeyIdentifier = hash
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, keyCertSign
subjectAltName=@san
[ san ]
DNS.1 = istiod.istio-system.svc
[ req_dn ]
O = Istio
CN = Intermediate CA
L = east
----

.. Create a certificate signing request by running the following command:
+
[source,terminal]
----
$ openssl req -new -config east/intermediate.conf \
   -key east/ca-key.pem \
   -out east/cluster-ca.csr
----

.. Create the intermediate CA certificate for the East cluster by running the following command:
+
[source,terminal]
----  
$ openssl x509 -req -sha256 -days 3650 \
   -CA root-cert.pem \
   -CAkey root-key.pem -CAcreateserial \
   -extensions req_ext -extfile east/intermediate.conf \
   -in east/cluster-ca.csr \
   -out east/ca-cert.pem
----

.. Create a certificate chain from the intermediate and root CA certificate for the east cluster by running the following command:
+
[source,terminal]
----
$ cat east/ca-cert.pem root-cert.pem > east/cert-chain.pem && cp root-cert.pem east
----

. Create the intermediate CA certificate for the West cluster:

.. Create a directory named `west` by running the following command:
+
[source,terminal]
----
$ mkdir west
----

.. Create a key for the intermediate certificate for the West cluster by running the following command:
+
[source,terminal]
----
$ openssl genrsa -out west/ca-key.pem 4096
----

.. Create an OpenSSL configuration file named `intermediate.conf` in the `west/` directory for for the intermediate certificate of the West cluster. Copy the following example file and save it locally:
+
.Example configuration file
[source,subs="attributes,verbatim"]
----
[ req ]
encrypt_key = no
prompt = no
utf8 = yes
default_md = sha256
default_bits = 4096
req_extensions = req_ext
x509_extensions = req_ext
distinguished_name = req_dn
[ req_ext ]
subjectKeyIdentifier = hash
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, keyCertSign
subjectAltName=@san
[ san ]
DNS.1 = istiod.istio-system.svc
[ req_dn ]
O = Istio
CN = Intermediate CA
L = west
----

.. Create a certificate signing request by running the following command:
+
[source,terminal]
----
$ openssl req -new -config west/intermediate.conf \
   -key west/ca-key.pem \
   -out west/cluster-ca.csr
----

.. Create the certificate by running the following command:
+
[source,terminal]
----
$ openssl x509 -req -sha256 -days 3650 \
   -CA root-cert.pem \
   -CAkey root-key.pem -CAcreateserial \
   -extensions req_ext -extfile west/intermediate.conf \
   -in west/cluster-ca.csr \
   -out west/ca-cert.pem
----

.. Create the certificate chain by running the following command:
+
[source,terminal]
----
$ cat west/ca-cert.pem root-cert.pem > west/cert-chain.pem && cp root-cert.pem west
----