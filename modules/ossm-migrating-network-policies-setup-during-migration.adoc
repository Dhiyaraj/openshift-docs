// Module included in the following assemblies:
//
// * service-mesh-docs-main/migrating/checklists/ossm-migrating-network-policies.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-migrating-network-policies-setup-during-migration_{context}"]
= Set up network policies to use during migration

You can set up network policies to use during your migration.

[IMPORTANT]
====
* During the recreation of network policies from {SMProduct} 2 to {SMProduct} 3, both control planes must have access to all workloads and all workloads must have access to control planes.

* The `maistra.io/member-of:` label is removed from the namespaces during migration.
====

.Prerequisites

* You have deployed {ocp-product-title} 4.14 or later.
* You are logged in to the {ocp-product-title} web console as a user with the cluster-admin role.
* You have the {SMProduct} {SMv2Version} Operator installed.
* You have the `ServiceMeshControlPlane` 2.6 resource installed.
* In {SMProduct} 2, you have set `spec.security.manageNetworkPolicy=true` in your  `ServiceMeshControlPlane` resource.
* You have deployed the `bookinfo` and `bookinfo2` applications.

.Procedure

. Label namespaces by running the following command:
+
[source,terminal]
----
$ oc label namespace <app_namespace> service-mesh=enabled
----
+
[NOTE]
====
Use a label scoped specifically to your mesh that you can reuse for discovery selectors.
====

. Create your network policies by using the following `NetworkPolicy` example configurations:
+
.Example of an Istiod network policy in a mesh namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istiod-basic
  namespace: istio-system
spec:
  ingress:
    - {}
  podSelector:
    matchLabels:
      app: istiod
      istio.io/rev: basic
  policyTypes:
    - Ingress
--
+
.Example of an expose route policy in a mesh namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: expose-route-basic
  namespace: istio-system
spec:
  podSelector:
    matchLabels:
      maistra.io/expose-route: "true"
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              network.openshift.io/policy-group: ingress
  policyTypes:
    - Ingress
--
+
.Example of a default mesh network policy in a mesh namespace
[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-mesh
  namespace: istio-system
spec:
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              service-mesh: enabled
  podSelector: {}
  policyTypes:
    - Ingress
----
+
.Example expose route network policy in the `bookinfo` namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-expose-route
  namespace: bookinfo
spec:
  podSelector:
    matchLabels:
      maistra.io/expose-route: "true"
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              network.openshift.io/policy-group: ingress
  policyTypes:
    - Ingress
--
+
.Example mesh network policy in the `bookinfo` namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-mesh
  namespace: bookinfo
spec:
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              service-mesh: enabled
  podSelector: {}
  policyTypes:
    - Ingress
--
+
.Example expose route network policy in the `bookinfo2` namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-expose-route
  namespace: bookinfo2
spec:
  podSelector:
    matchLabels:
      maistra.io/expose-route: "true"
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              network.openshift.io/policy-group: ingress
  policyTypes:

--
+
.Example mesh network policy in the `bookinfo2` namespace
[source,yaml]
--
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-mesh
  namespace: bookinfo2
spec:
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              service-mesh: enabled
  podSelector: {}
  policyTypes:
    - Ingress
--

. Disable network policies in {SMProduct} 2 by setting the `spec.security.manageNetworkPolicy` field to `false` in your `ServiceMeshControlPlane` resource.
+
[NOTE]
====
Setting the `spec.security.manageNetworkPolicy` field to `false` in your `ServiceMeshControlPlane` resource removes the network policies created by default in {SMProduct} 2.
====

. Find your current active revision by running the following command:
+
[source,terminal]
----
$ oc get istios <istio_name>
----
+
.Example output
[source,terminal]
----
NAME             REVISIONS   READY   IN USE   ACTIVE REVISION   STATUS    VERSION   AGE
istio-tenant-a   1           1       0        istio-tenant-a    Healthy   v1.24.3   30s
----

. Copy the active revision name from the output to use for your `istio.io/rev` label in your second Istiod network policy for {SMProduct} 3.

. Create a second Istiod network policy for {SMProduct} 3 by using the following `NetworkPolicy` example configuration:
+
.Sample policy
+
[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: istio-istiod-v3
  namespace: istio-system
spec:
  ingress:
    - {}
  podSelector:
    matchLabels:
      app: istiod
      istio.io/rev: istio-tenant-a <1>
  policyTypes:
    - Ingress
----
<1> Must match your current active revision name.


